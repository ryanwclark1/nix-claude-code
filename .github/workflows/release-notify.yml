name: Release Notification

on:
  push:
    branches:
      - main
    paths:
      - "package.nix"

permissions:
  discussions: write
  contents: read

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2 # Need previous commit to detect changes

      - name: Extract version information
        id: version
        run: |
          # Get current version
          CURRENT_VERSION=$(sed -n 's/.*version = "\([^"]*\)".*/\1/p' package.nix | head -1)
          echo "current=$CURRENT_VERSION" >> $GITHUB_OUTPUT

          # Get previous version
          git checkout HEAD~1 -- package.nix.old 2>/dev/null || touch package.nix.old
          PREVIOUS_VERSION=$(sed -n 's/.*version = "\([^"]*\)".*/\1/p' package.nix.old 2>/dev/null | head -1 || echo "unknown")
          rm -f package.nix.old
          echo "previous=$PREVIOUS_VERSION" >> $GITHUB_OUTPUT

          # Check if this is a version change
          if [ "$CURRENT_VERSION" != "$PREVIOUS_VERSION" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Create discussion post
        if: steps.version.outputs.changed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          CURRENT_VERSION="${{ steps.version.outputs.current }}"
          PREVIOUS_VERSION="${{ steps.version.outputs.previous }}"

          # Create discussion in Announcements category
          gh api graphql -f query='
            mutation($repositoryId: ID!, $categoryId: ID!, $body: String!, $title: String!) {
              createDiscussion(input: {repositoryId: $repositoryId, categoryId: $categoryId, body: $body, title: $title}) {
                discussion {
                  url
                }
              }
            }
          ' \
          -f repositoryId="$(gh repo view --json id -q .id)" \
          -f categoryId="$(gh api graphql -f query='query($owner: String!, $repo: String!) {
              repository(owner: $owner, name: $repo) {
                discussionCategories(first: 10) {
                  nodes {
                    id
                    name
                  }
                }
              }
            }' -f owner=ryanwclark1 -f repo=nix-claude-code | jq -r '.data.repository.discussionCategories.nodes[] | select(.name=="Announcements") | .id')" \
          -f title="ðŸ“¦ Claude Code $CURRENT_VERSION Released" \
          -f body="## New Version Available: $CURRENT_VERSION

          Claude Code has been updated from **$PREVIOUS_VERSION** to **$CURRENT_VERSION**.

          ### Quick Start

          \`\`\`bash
          # Run directly
          nix run github:ryanwclark1/nix-claude-code

          # Install to profile
          nix profile install github:ryanwclark1/nix-claude-code

          # Update existing installation
          nix profile upgrade claude-code
          # or
          nix flake update claude-code && nix build
          \`\`\`

          ### What's New

          See the [Claude Code release notes](https://www.anthropic.com/claude-code) for details on what's new in this version.

          ### Pinning This Version

          To pin to this specific version in your flake:

          \`\`\`nix
          inputs.claude-code.url = \"github:ryanwclark1/nix-claude-code?rev=${{ github.sha }}\";
          \`\`\`

          ### Changes

          - Updated Claude Code from $PREVIOUS_VERSION to $CURRENT_VERSION
          - Updated tarball hash
          - All tests passing âœ…

          See the [commit](${{ github.event.head_commit.url }}) for details.

          ### Documentation

          - [README.md](https://github.com/ryanwclark1/nix-claude-code/blob/main/README.md) - Installation and usage
          - [VERSIONING.md](https://github.com/ryanwclark1/nix-claude-code/blob/main/VERSIONING.md) - Version management
          - [examples/](https://github.com/ryanwclark1/nix-claude-code/tree/main/examples) - Integration examples

          ---

          ðŸ¤– This announcement was automatically generated by the release notification workflow."

      - name: Create summary
        if: steps.version.outputs.changed == 'true'
        run: |
          echo "## Release Notification Posted" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Previous Version:** ${{ steps.version.outputs.previous }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Current Version:** ${{ steps.version.outputs.current }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "A discussion post has been created announcing the new version." >> $GITHUB_STEP_SUMMARY
